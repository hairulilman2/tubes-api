<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>absensi untad - Sistem Absensi</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      /* CSS khusus untuk peta */
      #map {
        height: 400px !important;
        width: 100% !important;
        border-radius: 10px;
        border: 2px solid #ddd;
        z-index: 1;
      }
      
      .leaflet-container {
        height: 400px !important;
        width: 100% !important;
      }
      
      .peta-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        margin: 20px 0;
      }
      
      @media (max-width: 768px) {
        .peta-container {
          grid-template-columns: 1fr;
        }
      }
      
      /* Modal styling */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
      
      /* User item styling */
      .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        background: #f8f9fa;
      }
      
      .user-actions {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }
      
      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      
      .btn-warning:hover {
        background: #e0a800;
      }
      
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      
      .btn-danger:hover {
        background: #c82333;
      }
    </style>
  </head>
  <body class="login-mode">
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
      <div class="header">
        <svg width="80" height="80" viewBox="0 0 80 80" class="logo-img">
          <circle cx="40" cy="40" r="40" fill="url(#gradient)" />
          <text
            x="40"
            y="45"
            text-anchor="middle"
            fill="white"
            font-family="Arial"
            font-size="14"
            font-weight="bold"
          >
            LOGO
          </text>
          <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color: #2c5e2e; stop-opacity: 1" />
              <stop offset="100%" style="stop-color: #4a7c59; stop-opacity: 1" />
            </linearGradient>
          </defs>
        </svg>
        <h1 class="title">ABSENSI</h1>
        <p class="subtitle">Universitas</p>
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="username">username..</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Masukkan username"
            required
          />
        </div>

        <div class="form-group">
          <label for="password">password..</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Masukkan password"
            required
          />
        </div>

        <div class="form-group">
          <label for="role">login sebagai:</label>
          <select id="role" name="role">
            <option value="mahasiswa">Mahasiswa</option>
            <option value="dosen">Dosen</option>
          </select>
        </div>

        <button type="submit" class="login-button">LOGIN</button>
      </form>

      <div id="loginResult" class="result"></div>
      
        <p><small>Jika masih bermasalah, hubungi admin untuk reset password.</small></p>
      </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
      <div class="container">
        <div class="app-header">
          <button class="logout-btn" onclick="logout()">Logout</button>
          <h1>üìç Sistem Absensi CERDAS UNTAD</h1>
          <p>Berbasis Lokasi dengan AdonisJS & MongoDB Atlas</p>
        </div>

        <div class="content">
          <div class="tabs">
            <button class="tab" onclick="showTab('absenPeta')" id="absenPetaTab" style="display: none">
              Absensi
            </button>
            <button class="tab" onclick="showTab('admin')" id="adminTab" style="display: none">
              Admin Panel
            </button>
            <button class="tab" onclick="showTab('dosen')" id="dosenTab" style="display: none">
              Panel Dosen
            </button>

          </div>

          <!-- Absen dengan Peta Tab -->
          <div id="absenPeta" class="tab-content">
            <h3>üìç Absensi Mahasiswa</h3>
            
            <div class="peta-container">
              <div class="map-section">
                <div id="map"></div>
              </div>

              <div class="peta-sidebar" style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef;">
                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>üë§ Data Mahasiswa</h4>
                  <div class="form-group">
                    <label>Nama:</label>
                    <input type="text" id="mahasiswaName" placeholder="Masukkan nama lengkap" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                  </div>
                  <div class="form-group">
                    <label>NIM:</label>
                    <input type="text" id="mahasiswaNIM" placeholder="Masukkan NIM" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                  </div>
                  <div class="form-group">
                    <label>Mata Kuliah:</label>
                    <select id="mahasiswaMatkul" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                      <option value="">Pilih Mata Kuliah</option>
                      <option value="Pemrograman Web">Pemrograman Web</option>
                      <option value="Basis Data">Basis Data</option>
                      <option value="Algoritma dan Struktur Data">Algoritma dan Struktur Data</option>
                      <option value="Sistem Operasi">Sistem Operasi</option>
                      <option value="Jaringan Komputer">Jaringan Komputer</option>
                      <option value="Rekayasa Perangkat Lunak">Rekayasa Perangkat Lunak</option>
                    </select>
                  </div>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>üìç Informasi Lokasi</h4>
                  <div id="location-info">
                    <p>Mencari lokasi Anda...</p>
                  </div>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>üéØ Status Absensi</h4>
                  <div id="attendance-status" class="status luar-radius" style="padding: 8px 15px; border-radius: 20px; font-weight: bold; text-align: center; margin: 10px 0; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                    Belum dapat lokasi
                  </div>
                  <div id="distance-info" style="font-size: 14px; color: #666; margin: 10px 0;"></div>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>‚öôÔ∏è Kontrol</h4>
                  <button id="get-location" class="btn btn-primary" style="width: 100%; margin: 5px 0;">
                    üìç Dapatkan Lokasi Saya
                  </button>
                  <button id="absen-peta-btn" class="btn btn-success" disabled style="width: 100%; margin: 5px 0;">
                    ‚úÖ ABSEN SEKARANG
                  </button>
                  <button onclick="initMap()" class="btn btn-warning" style="width: 100%; margin: 5px 0;">
                    üó∫Ô∏è Reload Peta
                  </button>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>‚ÑπÔ∏è Informasi</h4>
                  <p><strong>Lokasi Absensi:</strong> Ruang Kelas A1</p>
                  <p><strong>Radius:</strong> 5 meter</p>
                  <p><strong>Waktu:</strong> <span id="current-time"></span></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Admin Panel Tab -->
          <div id="admin" class="tab-content">
            <h3>üîê Admin Panel</h3>

            <!-- Stats -->
            <div class="stats">
              <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalDosen">0</div>
                <div class="stat-label">Total Dosen</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalMahasiswa">0</div>
                <div class="stat-label">Total Mahasiswa</div>
              </div>
            </div>

            <!-- Admin Tabs -->
            <div class="admin-tabs">
              <button class="admin-tab active" onclick="showAdminTab('registerUser')">
                Daftar User
              </button>
              <button class="admin-tab" onclick="showAdminTab('manageUsers')">Kelola User</button>
            </div>

            <!-- Register User -->
            <div id="adminRegisterUser" class="admin-tab-content active">
              <h4>üìù Daftarkan User Baru</h4>
              <form id="adminRegisterForm" class="admin-form">
                <div class="form-group">
                  <label>Nama:</label>
                  <input type="text" id="adminRegName" required />
                </div>
                <div class="form-group">
                  <label id="adminRegEmailLabel">NIM/NIP:</label>
                  <input type="text" id="adminRegEmail" required />
                </div>
                <div class="form-group">
                  <label>Password:</label>
                  <input type="password" id="adminRegPassword" required />
                </div>
                <div class="form-group">
                  <label>Role:</label>
                  <select id="adminRegRole" onchange="toggleAdminLocationFields()">
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen</option>
                  </select>
                </div>
                <div id="adminLocationFields" class="location-fields" style="display: none">
                  <div class="info-box">
                    <h5>‚ÑπÔ∏è Info Dosen</h5>
                    <p>
                      <small
                        >Lokasi akan diatur oleh dosen sendiri setelah login (radius validasi: 5
                        meter). Admin hanya perlu mendaftarkan akun dosen.</small
                      >
                    </p>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Daftarkan User</button>
              </form>
              <div id="adminRegisterResult" class="result"></div>
            </div>

            <!-- Manage Users -->
            <div id="adminManageUsers" class="admin-tab-content">
              <h4>üë• Kelola User</h4>
              <button class="btn btn-secondary" onclick="loadAllUsersAdmin()">Refresh Data</button>
              <div id="adminUsersList" class="users-list"></div>
            </div>
          </div>

          <!-- Modal Edit User -->
          <div id="editUserModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
              <h4>‚úèÔ∏è Edit User</h4>
              <form id="editUserForm">
                <input type="hidden" id="editUserId" />
                <div class="form-group">
                  <label>Nama:</label>
                  <input type="text" id="editUserName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                </div>
                <div class="form-group">
                  <label>Email/Username:</label>
                  <input type="text" id="editUserEmail" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                </div>
                <div class="form-group">
                  <label>Role:</label>
                  <select id="editUserRole" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Password Baru (kosongkan jika tidak ingin mengubah):</label>
                  <input type="password" id="editUserPassword" placeholder="Masukkan password baru" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                </div>
                <div style="margin-top: 20px; text-align: right;">
                  <button type="button" onclick="closeEditModal()" class="btn btn-secondary" style="margin-right: 10px;">Batal</button>
                  <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
              </form>
              <div id="editUserResult" class="result"></div>
            </div>
          </div>

          <!-- Panel Dosen Tab -->
          <div id="dosen" class="tab-content">
            <h3>üë®‚Äçüè´ Panel Dosen</h3>
            
            <!-- Dosen Info -->
            <div class="dosen-info" style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üìã Informasi Dosen</h4>
              <p><strong>Nama:</strong> <span id="dosenName">Loading...</span></p>
              <p><strong>NIP:</strong> <span id="dosenNIP">Loading...</span></p>
              <div class="form-group">
                <label><strong>Mata Kuliah:</strong></label>
                <select id="dosenMatkul" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                  <option value="">Pilih Mata Kuliah</option>
                  <option value="Pemrograman Web">Pemrograman Web</option>
                  <option value="Basis Data">Basis Data</option>
                  <option value="Algoritma dan Struktur Data">Algoritma dan Struktur Data</option>
                  <option value="Sistem Operasi">Sistem Operasi</option>
                  <option value="Jaringan Komputer">Jaringan Komputer</option>
                  <option value="Rekayasa Perangkat Lunak">Rekayasa Perangkat Lunak</option>
                </select>
              </div>
              <p><strong>Status Session:</strong> <span id="sessionStatus">Tidak Aktif</span></p>
            </div>

            <!-- Location Setting -->
            <div class="location-setting" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üìç Pengaturan Lokasi Ruang Kelas</h4>
              <div class="form-group">
                <label>Latitude:</label>
                <input type="number" id="dosenLat" step="any" placeholder="-0.8415911" />
              </div>
              <div class="form-group">
                <label>Longitude:</label>
                <input type="number" id="dosenLng" step="any" placeholder="119.8927127" />
              </div>
              <div class="location-buttons">
                <button class="btn btn-info" onclick="getDosenLocation()">üìç Ambil Lokasi Saat Ini</button>
                <button class="btn btn-success" onclick="saveDosenLocation()">üíæ Simpan Lokasi</button>
                <button class="btn btn-warning" onclick="shareCurrentLocation()">üì§ Share Lokasi</button>
              </div>
              <div id="locationResult" class="result"></div>
              <div id="shareLocation"></div>
            </div>

            <!-- Peta Dosen -->
            <div class="dosen-map" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #dee2e6;">
              <h4>üó∫Ô∏è Peta Lokasi Kelas</h4>
              <div id="dosenMap" style="height: 300px; border-radius: 10px; border: 2px solid #ddd;"></div>
              <div style="margin-top: 10px;">
                <button onclick="initDosenMap()" class="btn btn-info">üîÑ Refresh Peta</button>
                <button onclick="centerDosenMap()" class="btn btn-warning">üéØ Center ke Lokasi</button>
              </div>
            </div>

            <!-- Session Control -->
            <div class="session-control" style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>‚è∞ Kontrol Session Absensi</h4>
              <p><small>Session absensi berlangsung selama 15 menit. Mahasiswa hanya bisa absen selama session aktif.</small></p>
              <button class="btn btn-primary" onclick="startAttendanceSession()">üöÄ Mulai Session Absensi</button>
              <div id="sessionTimer" style="margin-top: 15px; font-weight: bold; font-size: 18px;"></div>
            </div>

            <!-- Attendance List -->
            <div class="attendance-list" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6;">
              <h4>üìä Daftar Absensi Mahasiswa</h4>
              <button class="btn btn-secondary" onclick="loadDosenAttendances()">üîÑ Refresh Data</button>
              <div id="dosenAttendancesList" style="margin-top: 15px;"></div>
            </div>
          </div>


        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="script.js"></script>
    
    <script>
        // Konfigurasi lokasi absensi (koordinat ruang kelas)
        const ATTENDANCE_LOCATION = {
            lat: -0.8415911,  // Koordinat UNTAD
            lng: 119.8927127,
            name: "Ruang Kelas A1 - UNTAD"
        };

        const ATTENDANCE_RADIUS = 5; // meter
        
        let map;
        let dosenMap;
        let userMarker;
        let attendanceMarker;
        let radiusCircle;
        let dosenMarker;
        let dosenRadiusCircle;
        let userLocation = null;
        let dosenLocation = null;

        // Inisialisasi peta
        function initMap() {
            const mapElement = document.getElementById('map');
            console.log('Initializing map, element found:', !!mapElement);
            
            if (mapElement) {
                try {
                    // Hapus peta lama jika ada
                    if (map) {
                        map.remove();
                    }
                    
                    // Buat peta dengan center di lokasi absensi
                    map = L.map('map', {
                        center: [ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng],
                        zoom: 16,
                        zoomControl: true
                    });

                    // Tambahkan tile layer (peta dasar)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    console.log('Map initialized successfully');

                // Marker untuk lokasi absensi
                attendanceMarker = L.marker([ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);

                attendanceMarker.bindPopup(`
                    <b>${ATTENDANCE_LOCATION.name}</b><br>
                    Lokasi Absensi<br>
                    Radius: ${ATTENDANCE_RADIUS}m
                `);

                    // Lingkaran radius absensi
                    radiusCircle = L.circle([ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng], {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.2,
                        radius: ATTENDANCE_RADIUS
                    }).addTo(map);
                    
                    // Force map resize setelah inisialisasi
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                    
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            } else {
                console.error('Map element not found!');
            }
        }

        // Dapatkan lokasi pengguna
        function getUserLocation() {
            const locationInfo = document.getElementById('location-info');
            const getLocationBtn = document.getElementById('get-location');
            
            if (!getLocationBtn) return;
            
            getLocationBtn.disabled = true;
            getLocationBtn.textContent = 'üìç Mencari lokasi...';
            locationInfo.innerHTML = '<p>üîç Mencari lokasi Anda...</p>';

            if (!navigator.geolocation) {
                locationInfo.innerHTML = '<p style="color: red;">‚ùå Geolocation tidak didukung browser ini</p>';
                getLocationBtn.disabled = false;
                getLocationBtn.textContent = 'üìç Dapatkan Lokasi Saya';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Update info lokasi
                    locationInfo.innerHTML = `
                        <p><strong>Latitude:</strong> ${userLocation.lat.toFixed(6)}</p>
                        <p><strong>Longitude:</strong> ${userLocation.lng.toFixed(6)}</p>
                        <p><strong>Akurasi:</strong> ¬±${position.coords.accuracy.toFixed(0)}m</p>
                    `;

                    // Tambahkan marker pengguna
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    userMarker = L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);

                    userMarker.bindPopup('üìç Lokasi Anda');

                    // Hitung jarak dan update status
                    checkAttendanceEligibility();

                    // Reset tombol
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'üîÑ Perbarui Lokasi';

                    // Sesuaikan view peta untuk menampilkan kedua marker
                    const group = new L.featureGroup([userMarker, attendanceMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                },
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '‚ùå Akses lokasi ditolak. Silakan izinkan akses lokasi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '‚ùå Informasi lokasi tidak tersedia.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚ùå Timeout mencari lokasi.';
                            break;
                        default:
                            errorMsg = '‚ùå Error tidak dikenal.';
                            break;
                    }
                    
                    locationInfo.innerHTML = `<p style="color: red;">${errorMsg}</p>`;
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'üìç Coba Lagi';
                }
            );
        }

        // Hitung jarak antara dua koordinat (Haversine formula)
        function calculateDistancePeta(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Radius bumi dalam meter
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Jarak dalam meter
        }

        // Periksa kelayakan absensi
        function checkAttendanceEligibility() {
            if (!userLocation) return;

            const distance = calculateDistancePeta(
                userLocation.lat, userLocation.lng,
                ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng
            );

            const statusDiv = document.getElementById('attendance-status');
            const distanceInfo = document.getElementById('distance-info');
            const absenBtn = document.getElementById('absen-peta-btn');

            if (!statusDiv || !distanceInfo || !absenBtn) return;

            distanceInfo.innerHTML = `üìè Jarak dari lokasi absensi: <strong>${distance.toFixed(1)} meter</strong>`;

            // Cek apakah nama, NIM, dan mata kuliah sudah diisi
            const mahasiswaName = document.getElementById('mahasiswaName').value.trim();
            const mahasiswaNIM = document.getElementById('mahasiswaNIM').value.trim();
            const mahasiswaMatkul = document.getElementById('mahasiswaMatkul').value;
            const isDataComplete = mahasiswaName && mahasiswaNIM && mahasiswaMatkul;

            if (distance <= ATTENDANCE_RADIUS && isDataComplete) {
                statusDiv.textContent = '‚úÖ Siap untuk absen';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                absenBtn.disabled = false;
                absenBtn.textContent = '‚úÖ ABSEN SEKARANG';
            } else if (distance <= ATTENDANCE_RADIUS && !isDataComplete) {
                statusDiv.textContent = '‚ö†Ô∏è Lengkapi data mahasiswa';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
                absenBtn.disabled = true;
                absenBtn.textContent = '‚ö†Ô∏è Lengkapi Data';
            } else {
                statusDiv.textContent = '‚ùå Di luar radius absensi';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                absenBtn.disabled = true;
                absenBtn.textContent = `‚ùå Terlalu jauh (${(distance - ATTENDANCE_RADIUS).toFixed(1)}m)`;
            }
        }

        // Proses absensi
        function processAttendancePeta() {
            // Validasi input mahasiswa
            const mahasiswaName = document.getElementById('mahasiswaName').value.trim();
            const mahasiswaNIM = document.getElementById('mahasiswaNIM').value.trim();
            const mahasiswaMatkul = document.getElementById('mahasiswaMatkul').value;
            
            if (!mahasiswaName) {
                alert('‚ùå Masukkan nama mahasiswa!');
                document.getElementById('mahasiswaName').focus();
                return;
            }
            
            if (!mahasiswaNIM) {
                alert('‚ùå Masukkan NIM mahasiswa!');
                document.getElementById('mahasiswaNIM').focus();
                return;
            }
            
            if (!mahasiswaMatkul) {
                alert('‚ùå Pilih mata kuliah!');
                document.getElementById('mahasiswaMatkul').focus();
                return;
            }
            
            if (!userLocation) {
                alert('‚ùå Lokasi belum didapatkan!');
                return;
            }

            const distance = calculateDistancePeta(
                userLocation.lat, userLocation.lng,
                ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng
            );

            if (distance > ATTENDANCE_RADIUS) {
                alert('‚ùå Anda berada di luar radius absensi!');
                return;
            }

            // Proses absensi
            const absenBtn = document.getElementById('absen-peta-btn');
            absenBtn.disabled = true;
            absenBtn.textContent = '‚è≥ Memproses...';

            // Data absensi
            const attendanceData = {
                name: mahasiswaName,
                nim: mahasiswaNIM,
                matakuliah: mahasiswaMatkul,
                latitude: userLocation.lat,
                longitude: userLocation.lng,
                distance: distance.toFixed(1),
                timestamp: new Date().toISOString()
            };

            // Simulasi API call
            setTimeout(() => {
                alert(`‚úÖ Absensi berhasil!\n\nNama: ${mahasiswaName}\nNIM: ${mahasiswaNIM}\nMata Kuliah: ${mahasiswaMatkul}\nWaktu: ${new Date().toLocaleString('id-ID')}\nJarak: ${distance.toFixed(1)} meter`);
                absenBtn.textContent = '‚úÖ Sudah Absen';
                absenBtn.style.background = '#6c757d';
                
                // Disable input fields setelah absen berhasil
                document.getElementById('mahasiswaName').disabled = true;
                document.getElementById('mahasiswaNIM').disabled = true;
                document.getElementById('mahasiswaMatkul').disabled = true;
            }, 2000);
        }

        // Inisialisasi peta dosen
        function initDosenMap() {
            const mapElement = document.getElementById('dosenMap');
            console.log('Initializing dosen map, element found:', !!mapElement);
            
            if (mapElement) {
                try {
                    // Hapus peta lama jika ada
                    if (dosenMap) {
                        dosenMap.remove();
                    }
                    
                    // Ambil koordinat dari input atau gunakan default
                    const lat = parseFloat(document.getElementById('dosenLat').value) || ATTENDANCE_LOCATION.lat;
                    const lng = parseFloat(document.getElementById('dosenLng').value) || ATTENDANCE_LOCATION.lng;
                    
                    dosenLocation = { lat, lng };
                    
                    // Buat peta dosen
                    dosenMap = L.map('dosenMap', {
                        center: [lat, lng],
                        zoom: 16,
                        zoomControl: true
                    });

                    // Tambahkan tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(dosenMap);
                    
                    // Marker untuk lokasi dosen
                    dosenMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(dosenMap);

                    dosenMarker.bindPopup(`
                        <b>Lokasi Kelas Dosen</b><br>
                        Radius Absensi: ${ATTENDANCE_RADIUS}m
                    `);

                    // Lingkaran radius absensi
                    dosenRadiusCircle = L.circle([lat, lng], {
                        color: 'green',
                        fillColor: '#0f3',
                        fillOpacity: 0.2,
                        radius: ATTENDANCE_RADIUS
                    }).addTo(dosenMap);
                    
                    // Force map resize
                    setTimeout(() => {
                        dosenMap.invalidateSize();
                    }, 100);
                    
                    console.log('Dosen map initialized successfully');
                    
                } catch (error) {
                    console.error('Error initializing dosen map:', error);
                }
            }
        }
        
        // Center peta dosen ke lokasi yang diset
        function centerDosenMap() {
            const lat = parseFloat(document.getElementById('dosenLat').value);
            const lng = parseFloat(document.getElementById('dosenLng').value);
            
            if (dosenMap && lat && lng) {
                dosenMap.setView([lat, lng], 16);
                
                // Update marker dan circle
                if (dosenMarker) {
                    dosenMarker.setLatLng([lat, lng]);
                }
                if (dosenRadiusCircle) {
                    dosenRadiusCircle.setLatLng([lat, lng]);
                }
            }
        }

        // Update waktu real-time
        function updateTime() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleString('id-ID');
            }
        }

        // Event listeners untuk peta
        document.addEventListener('DOMContentLoaded', function() {
            // Update waktu setiap detik
            updateTime();
            setInterval(updateTime, 1000);

            // Event listeners untuk tombol peta
            const getLocationBtn = document.getElementById('get-location');
            const absenPetaBtn = document.getElementById('absen-peta-btn');
            
            if (getLocationBtn) {
                getLocationBtn.addEventListener('click', getUserLocation);
            }
            
            if (absenPetaBtn) {
                absenPetaBtn.addEventListener('click', processAttendancePeta);
            }
            
            // Event listeners untuk input mahasiswa
            const mahasiswaName = document.getElementById('mahasiswaName');
            const mahasiswaNIM = document.getElementById('mahasiswaNIM');
            const mahasiswaMatkul = document.getElementById('mahasiswaMatkul');
            
            if (mahasiswaName) {
                mahasiswaName.addEventListener('input', checkAttendanceEligibility);
            }
            
            if (mahasiswaNIM) {
                mahasiswaNIM.addEventListener('input', checkAttendanceEligibility);
            }
            
            if (mahasiswaMatkul) {
                mahasiswaMatkul.addEventListener('change', checkAttendanceEligibility);
            }
        });

        // Override showTab function untuk handle peta
        const originalShowTab = window.showTab;
        window.showTab = function(tabName) {
            console.log('Switching to tab:', tabName);
            
            if (originalShowTab) {
                originalShowTab(tabName);
            }
            
            // Inisialisasi peta ketika tab absenPeta dibuka
            if (tabName === 'absenPeta') {
                console.log('Initializing map for absenPeta tab');
                setTimeout(() => {
                    initMap();
                    // Auto-get location saat tab dibuka
                    setTimeout(() => {
                        if (typeof getUserLocation === 'function') {
                            getUserLocation();
                        }
                    }, 1500);
                }, 300);
            }
            
            // Inisialisasi peta dosen ketika tab dosen dibuka
            if (tabName === 'dosen') {
                console.log('Initializing dosen map for dosen tab');
                setTimeout(() => {
                    initDosenMap();
                }, 300);
            }
        };
        
        // Tambahkan event listener untuk tab absenPeta
        document.addEventListener('DOMContentLoaded', function() {
            const absenPetaTab = document.getElementById('absenPetaTab');
            if (absenPetaTab) {
                absenPetaTab.addEventListener('click', function() {
                    console.log('AbsenPeta tab clicked directly');
                    setTimeout(() => {
                        initMap();
                    }, 300);
                });
            }
        });
    </script>
  </body>
</html>
