<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>absensi untad - Sistem Absensi</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      /* CSS khusus untuk peta */
      #map {
        height: 400px !important;
        width: 100% !important;
        border-radius: 10px;
        border: 2px solid #ddd;
        z-index: 1;
      }
      
      .leaflet-container {
        height: 400px !important;
        width: 100% !important;
      }
      
      .peta-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        margin: 20px 0;
      }
      
      @media (max-width: 768px) {
        .peta-container {
          grid-template-columns: 1fr;
        }
      }
      
      /* Modal styling */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
      
      /* User item styling */
      .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        background: #f8f9fa;
      }
      
      .user-actions {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }
      
      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      
      .btn-warning:hover {
        background: #e0a800;
      }
      
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      
      .btn-danger:hover {
        background: #c82333;
      }
      
      /* Badge styling */
      .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
      }
      
      .badge-success {
        background: #28a745;
        color: white;
      }
      
      .badge-warning {
        background: #ffc107;
        color: #212529;
      }
      
      /* Zoom specific styling */
      .meeting-item {
        transition: all 0.3s;
      }
      
      .meeting-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }
      
      .zoom-info {
        border-left: 4px solid #2196F3;
      }
      
      .active-meeting {
        border-left: 4px solid #4CAF50;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
        100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
      }
    </style>
  </head>
  <body class="login-mode">
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
      <div class="header">
        <svg width="80" height="80" viewBox="0 0 80 80" class="logo-img">
          <circle cx="40" cy="40" r="40" fill="url(#gradient)" />
          <text
            x="40"
            y="45"
            text-anchor="middle"
            fill="white"
            font-family="Arial"
            font-size="14"
            font-weight="bold"
          >
            LOGO
          </text>
          <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color: #2c5e2e; stop-opacity: 1" />
              <stop offset="100%" style="stop-color: #4a7c59; stop-opacity: 1" />
            </linearGradient>
          </defs>
        </svg>
        <h1 class="title">ABSENSI</h1>
        <p class="subtitle">Universitas</p>
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="username">username..</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Masukkan username"
            required
          />
        </div>

        <div class="form-group">
          <label for="password">password..</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Masukkan password"
            required
          />
        </div>

        <div class="form-group">
          <label for="role">login sebagai:</label>
          <select id="role" name="role">
            <option value="mahasiswa">Mahasiswa</option>
            <option value="dosen">Dosen</option>
          </select>
        </div>

        <button type="submit" class="login-button">LOGIN</button>
      </form>

      <div id="loginResult" class="result"></div>
      
        <p><small>Jika masih bermasalah, hubungi admin untuk reset password.</small></p>
      </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
      <div class="container">
        <div class="app-header">
          <button class="logout-btn" onclick="logout()">Logout</button>
          <h1>üìç Sistem Absensi CERDAS UNTAD</h1>
          <p>Berbasis Lokasi dengan AdonisJS & MongoDB Atlas</p>
        </div>

        <div class="content">
          <div class="tabs">
            <button class="tab" onclick="showTab('absenPeta')" id="absenPetaTab" style="display: none">
              Absensi
            </button>
            <button class="tab" onclick="showTab('zoomMahasiswa')" id="zoomMahasiswaTab" style="display: none">
              Join Zoom
            </button>
            <button class="tab" onclick="showTab('admin')" id="adminTab" style="display: none">
              Admin Panel
            </button>
            <button class="tab" onclick="showTab('dosen')" id="dosenTab" style="display: none">
              Panel Dosen
            </button>
            <button class="tab" onclick="showTab('zoom')" id="zoomTab" style="display: none">
              Zoom Meeting
            </button>

          </div>

          <!-- Absen dengan Peta Tab -->
          <div id="absenPeta" class="tab-content">
            <h3>üìç Absensi Mahasiswa</h3>
            
            <div class="peta-container">
              <div class="map-section">
                <div id="map"></div>
              </div>

              <div class="peta-sidebar" style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef;">
                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>üë§ Data Mahasiswa</h4>
                  <div class="form-group">
                    <label>Nama:</label>
                    <input type="text" id="mahasiswaName" placeholder="Masukkan nama lengkap" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                  </div>
                  <div class="form-group">
                    <label>NIM:</label>
                    <input type="text" id="mahasiswaNIM" placeholder="Masukkan NIM" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                  </div>
                  <div class="form-group">
                    <label>Mata Kuliah:</label>
                    <select id="mahasiswaMatkul" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                      <option value="">Pilih Mata Kuliah</option>
                      <option value="Pemrograman Web">Pemrograman Web</option>
                      <option value="Basis Data">Basis Data</option>
                      <option value="Algoritma dan Struktur Data">Algoritma dan Struktur Data</option>
                      <option value="Sistem Operasi">Sistem Operasi</option>
                      <option value="Jaringan Komputer">Jaringan Komputer</option>
                      <option value="Rekayasa Perangkat Lunak">Rekayasa Perangkat Lunak</option>
                    </select>
                  </div>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>üìç Informasi Lokasi</h4>
                  <div id="location-info">
                    <p>Mencari lokasi Anda...</p>
                  </div>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>üéØ Status Absensi</h4>
                  <div id="attendance-status" class="status luar-radius" style="padding: 8px 15px; border-radius: 20px; font-weight: bold; text-align: center; margin: 10px 0; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                    Belum dapat lokasi
                  </div>
                  <div id="distance-info" style="font-size: 14px; color: #666; margin: 10px 0;"></div>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>‚öôÔ∏è Kontrol</h4>
                  <button id="get-location" class="btn btn-primary" style="width: 100%; margin: 5px 0;">
                    üìç Dapatkan Lokasi Saya
                  </button>
                  <button id="absen-peta-btn" class="btn btn-success" disabled style="width: 100%; margin: 5px 0;">
                    ‚úÖ ABSEN SEKARANG
                  </button>
                  <button onclick="initMap()" class="btn btn-warning" style="width: 100%; margin: 5px 0;">
                    üó∫Ô∏è Reload Peta
                  </button>
                </div>

                <div class="info-card" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                  <h4>‚ÑπÔ∏è Informasi</h4>
                  <p><strong>Lokasi Absensi:</strong> Ruang Kelas A1</p>
                  <p><strong>Radius:</strong> 5 meter</p>
                  <p><strong>Waktu:</strong> <span id="current-time"></span></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Zoom Mahasiswa Tab -->
          <div id="zoomMahasiswa" class="tab-content">
            <h3>üìπ Join Zoom Meeting</h3>
            
            <!-- Mahasiswa Info -->
            <div class="mahasiswa-zoom-info" style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üë§ Info Mahasiswa</h4>
              <p><strong>Nama:</strong> <span id="zoomMahasiswaName">Loading...</span></p>
              <p><strong>NIM:</strong> <span id="zoomMahasiswaNIM">Loading...</span></p>
              <p><strong>Status:</strong> <span id="zoomMahasiswaStatus">Belum join meeting</span></p>
            </div>

            <!-- Join Meeting -->
            <div class="join-meeting" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üöÄ Join Meeting</h4>
              <div class="form-group">
                <label>Meeting ID:</label>
                <input type="text" id="joinMeetingId" placeholder="Masukkan Meeting ID (contoh: 282 899 2827)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
              </div>
              <div class="form-group">
                <label>Password (jika ada):</label>
                <input type="text" id="joinMeetingPassword" placeholder="Masukkan password meeting (opsional)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
              </div>
              <div class="form-group">
                <label>Nama untuk ditampilkan:</label>
                <input type="text" id="joinDisplayName" placeholder="Nama Anda di meeting" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
              </div>
              <button class="btn btn-primary" onclick="joinZoomMeeting()">üöÄ Join Meeting</button>
              <button class="btn btn-info" onclick="scanQRCode()" style="margin-left: 10px;">üì± Scan QR Code</button>
              <div id="joinMeetingResult" class="result"></div>
            </div>

            <!-- Active Meeting Info -->
            <div id="activeMeetingInfo" class="active-meeting-info" style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
              <h4>üü¢ Meeting Aktif</h4>
              <p><strong>Meeting ID:</strong> <span id="currentMeetingId"></span></p>
              <p><strong>Nama:</strong> <span id="currentDisplayName"></span></p>
              <p><strong>Status:</strong> <span id="currentMeetingStatus">Terhubung</span></p>
              <p><strong>Durasi:</strong> <span id="meetingDuration">00:00</span></p>
              <div style="margin-top: 15px;">
                <button class="btn btn-warning" onclick="leaveMeeting()">üö™ Keluar Meeting</button>
                <button class="btn btn-info" onclick="toggleMute()">üé§ Mute/Unmute</button>
              </div>
            </div>

            <!-- Meeting History -->
            <div class="meeting-history-mahasiswa" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6;">
              <h4>üìú Riwayat Meeting Saya</h4>
              <button class="btn btn-secondary" onclick="loadMahasiswaMeetingHistory()">üîÑ Refresh Riwayat</button>
              <div id="mahasiswaMeetingHistoryList" style="margin-top: 15px;"></div>
            </div>
          </div>

          <!-- Admin Panel Tab -->
          <div id="admin" class="tab-content">
            <h3>üîê Admin Panel</h3>

            <!-- Stats -->
            <div class="stats">
              <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalDosen">0</div>
                <div class="stat-label">Total Dosen</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalMahasiswa">0</div>
                <div class="stat-label">Total Mahasiswa</div>
              </div>
            </div>

            <!-- Admin Tabs -->
            <div class="admin-tabs">
              <button class="admin-tab active" onclick="showAdminTab('registerUser')">
                Daftar User
              </button>
              <button class="admin-tab" onclick="showAdminTab('manageUsers')">Kelola User</button>
            </div>

            <!-- Register User -->
            <div id="adminRegisterUser" class="admin-tab-content active">
              <h4>üìù Daftarkan User Baru</h4>
              <form id="adminRegisterForm" class="admin-form">
                <div class="form-group">
                  <label>Nama:</label>
                  <input type="text" id="adminRegName" required />
                </div>
                <div class="form-group">
                  <label id="adminRegEmailLabel">NIM/NIP:</label>
                  <input type="text" id="adminRegEmail" required />
                </div>
                <div class="form-group">
                  <label>Password:</label>
                  <input type="password" id="adminRegPassword" required />
                </div>
                <div class="form-group">
                  <label>Role:</label>
                  <select id="adminRegRole" onchange="toggleAdminLocationFields()">
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen</option>
                  </select>
                </div>
                <div id="adminLocationFields" class="location-fields" style="display: none">
                  <div class="info-box">
                    <h5>‚ÑπÔ∏è Info Dosen</h5>
                    <p>
                      <small
                        >Lokasi akan diatur oleh dosen sendiri setelah login (radius validasi: 5
                        meter). Admin hanya perlu mendaftarkan akun dosen.</small
                      >
                    </p>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Daftarkan User</button>
              </form>
              <div id="adminRegisterResult" class="result"></div>
            </div>

            <!-- Manage Users -->
            <div id="adminManageUsers" class="admin-tab-content">
              <h4>üë• Kelola User</h4>
              <button class="btn btn-secondary" onclick="loadAllUsersAdmin()">Refresh Data</button>
              <div id="adminUsersList" class="users-list"></div>
            </div>
          </div>

          <!-- Modal Edit User -->
          <div id="editUserModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
              <h4>‚úèÔ∏è Edit User</h4>
              <form id="editUserForm">
                <input type="hidden" id="editUserId" />
                <div class="form-group">
                  <label>Nama:</label>
                  <input type="text" id="editUserName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                </div>
                <div class="form-group">
                  <label>Email/Username:</label>
                  <input type="text" id="editUserEmail" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                </div>
                <div class="form-group">
                  <label>Role:</label>
                  <select id="editUserRole" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Password Baru (kosongkan jika tidak ingin mengubah):</label>
                  <input type="password" id="editUserPassword" placeholder="Masukkan password baru" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
                </div>
                <div style="margin-top: 20px; text-align: right;">
                  <button type="button" onclick="closeEditModal()" class="btn btn-secondary" style="margin-right: 10px;">Batal</button>
                  <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
              </form>
              <div id="editUserResult" class="result"></div>
            </div>
          </div>

          <!-- Panel Dosen Tab -->
          <div id="dosen" class="tab-content">
            <h3>üë®‚Äçüè´ Panel Dosen</h3>
            
            <!-- Dosen Info -->
            <div class="dosen-info" style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üìã Informasi Dosen</h4>
              <p><strong>Nama:</strong> <span id="dosenName">Loading...</span></p>
              <p><strong>NIP:</strong> <span id="dosenNIP">Loading...</span></p>
              <div class="form-group">
                <label><strong>Mata Kuliah:</strong></label>
                <select id="dosenMatkul" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                  <option value="">Pilih Mata Kuliah</option>
                  <option value="Pemrograman Web">Pemrograman Web</option>
                  <option value="Basis Data">Basis Data</option>
                  <option value="Algoritma dan Struktur Data">Algoritma dan Struktur Data</option>
                  <option value="Sistem Operasi">Sistem Operasi</option>
                  <option value="Jaringan Komputer">Jaringan Komputer</option>
                  <option value="Rekayasa Perangkat Lunak">Rekayasa Perangkat Lunak</option>
                </select>
              </div>
              <p><strong>Status Session:</strong> <span id="sessionStatus">Tidak Aktif</span></p>
            </div>

            <!-- Location Setting -->
            <div class="location-setting" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üìç Pengaturan Lokasi Ruang Kelas</h4>
              <div class="form-group">
                <label>Latitude:</label>
                <input type="number" id="dosenLat" step="any" placeholder="-0.8415911" />
              </div>
              <div class="form-group">
                <label>Longitude:</label>
                <input type="number" id="dosenLng" step="any" placeholder="119.8927127" />
              </div>
              <div class="location-buttons">
                <button class="btn btn-info" onclick="getDosenLocation()">üìç Ambil Lokasi Saat Ini</button>
                <button class="btn btn-success" onclick="saveDosenLocation()">üíæ Simpan Lokasi</button>
                <button class="btn btn-warning" onclick="shareCurrentLocation()">üì§ Share Lokasi</button>
              </div>
              <div id="locationResult" class="result"></div>
              <div id="shareLocation"></div>
            </div>

            <!-- Peta Dosen -->
            <div class="dosen-map" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #dee2e6;">
              <h4>üó∫Ô∏è Peta Lokasi Kelas</h4>
              <div id="dosenMap" style="height: 300px; border-radius: 10px; border: 2px solid #ddd;"></div>
              <div style="margin-top: 10px;">
                <button onclick="initDosenMap()" class="btn btn-info">üîÑ Refresh Peta</button>
                <button onclick="centerDosenMap()" class="btn btn-warning">üéØ Center ke Lokasi</button>
              </div>
            </div>

            <!-- Session Control -->
            <div class="session-control" style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>‚è∞ Kontrol Session Absensi</h4>
              <p><small>Session absensi berlangsung selama 15 menit. Mahasiswa hanya bisa absen selama session aktif.</small></p>
              <button class="btn btn-primary" onclick="startAttendanceSession()">üöÄ Mulai Session Absensi</button>
              <div id="sessionTimer" style="margin-top: 15px; font-weight: bold; font-size: 18px;"></div>
            </div>

            <!-- Attendance List -->
            <div class="attendance-list" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6;">
              <h4>üìä Daftar Absensi Mahasiswa</h4>
              <button class="btn btn-secondary" onclick="loadDosenAttendances()">üîÑ Refresh Data</button>
              <div id="dosenAttendancesList" style="margin-top: 15px;"></div>
            </div>
          </div>

          <!-- Zoom Meeting Tab -->
          <div id="zoom" class="tab-content">
            <h3>üìπ Zoom Meeting & Auto Attendance</h3>
            
            <!-- Zoom Meeting Info -->
            <div class="zoom-info" style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h4>üìä Info Meeting</h4>
              <p><strong>Dosen:</strong> <span id="zoomDosenName">Loading...</span></p>
              <p><strong>Mata Kuliah:</strong> <span id="zoomMatkul">Belum dipilih</span></p>
              <p><strong>Status Meeting:</strong> <span id="zoomStatus">Tidak Aktif</span></p>
            </div>

            <!-- Create Meeting -->
            <div class="create-meeting" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                <strong>‚ö†Ô∏è PENTING - DEMO MODE</strong><br>
                <small>Meeting ID yang di-generate otomatis <strong>TIDAK AKAN BEKERJA</strong> di Zoom sesungguhnya.</small><br><br>
                <strong>üîë Untuk Meeting Zoom yang Valid:</strong><br>
                <small>1. Masukkan <strong>Personal Meeting ID (PMI)</strong> Zoom Anda di field di bawah</small><br>
                <small>2. PMI bisa didapat dari: zoom.us ‚Üí Profile ‚Üí Personal Meeting ID</small><br>
                <small>3. Contoh PMI yang valid: <code>282 899 2827</code> atau <code>2828992827</code></small>
              </div>
              <h4>üéÜ Buat Meeting Baru</h4>
              <div class="form-group">
                <label>Judul Meeting:</label>
                <input type="text" id="meetingTitle" placeholder="Contoh: Kuliah Pemrograman Web - Pertemuan 1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;" />
              </div>
              <div class="form-group">
                <label>Mata Kuliah:</label>
                <select id="zoomMeetingMatkul" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                  <option value="">Pilih Mata Kuliah</option>
                  <option value="Pemrograman Web">Pemrograman Web</option>
                  <option value="Basis Data">Basis Data</option>
                  <option value="Algoritma dan Struktur Data">Algoritma dan Struktur Data</option>
                  <option value="Sistem Operasi">Sistem Operasi</option>
                  <option value="Jaringan Komputer">Jaringan Komputer</option>
                  <option value="Rekayasa Perangkat Lunak">Rekayasa Perangkat Lunak</option>
                </select>
              </div>
              <div class="form-group">
                <label>Durasi (menit):</label>
                <select id="meetingDuration" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0;">
                  <option value="60">60 menit</option>
                  <option value="90">90 menit</option>
                  <option value="120">120 menit</option>
                  <option value="150">150 menit</option>
                </select>
              </div>
              <div class="form-group">
                <label><strong>Personal Meeting ID (PMI) Zoom Anda:</strong></label>
                <input type="text" id="personalMeetingId" placeholder="Masukkan PMI Zoom Anda (contoh: 282 899 2827) - WAJIB untuk meeting yang valid!" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; border-color: #28a745;" />
                <small style="color: #28a745; font-weight: bold;">‚úÖ Hanya PMI Zoom Anda yang akan bekerja di aplikasi Zoom!</small><br>
                <small style="color: #666;">Kosongkan hanya untuk demo/testing (tidak akan bekerja di Zoom)</small>
              </div>
              <button class="btn btn-primary" onclick="createZoomMeeting()">üöÄ Buat Meeting</button>
              <button class="btn btn-info" onclick="showZoomInstructions()" style="margin-left: 10px;">üìù Panduan Setup Zoom</button>
              <button class="btn btn-secondary" onclick="fillExamplePMI()" style="margin-left: 10px;">üìù Contoh PMI</button>
              <div id="createMeetingResult" class="result"></div>
            </div>

            <!-- Active Meeting -->
            <div id="activeMeeting" class="active-meeting" style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
              <h4>üü¢ Meeting Aktif</h4>
              <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #28a745;">
                <p><strong>üéØ Meeting ID:</strong> <span id="activeMeetingId" style="font-size: 18px; font-weight: bold; color: #007bff;"></span></p>
                <p><strong>üîó Join URL:</strong> <a id="activeMeetingUrl" href="#" target="_blank" style="color: #28a745; text-decoration: underline;">Klik untuk join meeting</a></p>
                <p><strong>üîë Password:</strong> <span id="activeMeetingPassword" style="font-weight: bold; color: #dc3545;"></span></p>
                <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px;">
                  <small><strong>üìù Cara Join Manual:</strong></small><br>
                  <small>1. Buka aplikasi Zoom</small><br>
                  <small>2. Klik "Join Meeting"</small><br>
                  <small>3. Masukkan Meeting ID: <span id="manualMeetingId" style="font-weight: bold;"></span></small><br>
                  <small>4. Masukkan Password jika diminta</small>
                </div>
              </div>
              <p><strong>üë• Peserta:</strong> <span id="participantCount">0</span> orang</p>
              <div style="margin-top: 15px;">
                <button class="btn btn-info" onclick="refreshParticipants()">üîÑ Refresh Peserta</button>
                <button class="btn btn-warning" onclick="copyMeetingInfo()">üìã Copy Info</button>
                <button class="btn btn-danger" onclick="endZoomMeeting()">‚èπÔ∏è Akhiri Meeting</button>
              </div>
            </div>

            <!-- Meeting History -->
            <div class="meeting-history" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6;">
              <h4>üìú Riwayat Meeting & Absensi</h4>
              <button class="btn btn-secondary" onclick="loadMeetingHistory()">üîÑ Refresh Riwayat</button>
              <div id="meetingHistoryList" style="margin-top: 15px;"></div>
            </div>
          </div>


        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="script.js"></script>
    
    <script>
        // Konfigurasi lokasi absensi (koordinat ruang kelas)
        const ATTENDANCE_LOCATION = {
            lat: -0.8415911,  // Koordinat UNTAD
            lng: 119.8927127,
            name: "Ruang Kelas A1 - UNTAD"
        };

        const ATTENDANCE_RADIUS = 5; // meter
        
        let map;
        let dosenMap;
        let userMarker;
        let attendanceMarker;
        let radiusCircle;
        let dosenMarker;
        let dosenRadiusCircle;
        let userLocation = null;
        let dosenLocation = null;

        // Inisialisasi peta
        function initMap() {
            const mapElement = document.getElementById('map');
            console.log('Initializing map, element found:', !!mapElement);
            
            if (mapElement) {
                try {
                    // Hapus peta lama jika ada
                    if (map) {
                        map.remove();
                    }
                    
                    // Buat peta dengan center di lokasi absensi
                    map = L.map('map', {
                        center: [ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng],
                        zoom: 16,
                        zoomControl: true
                    });

                    // Tambahkan tile layer (peta dasar)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    console.log('Map initialized successfully');

                // Marker untuk lokasi absensi
                attendanceMarker = L.marker([ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);

                attendanceMarker.bindPopup(`
                    <b>${ATTENDANCE_LOCATION.name}</b><br>
                    Lokasi Absensi<br>
                    Radius: ${ATTENDANCE_RADIUS}m
                `);

                    // Lingkaran radius absensi
                    radiusCircle = L.circle([ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng], {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.2,
                        radius: ATTENDANCE_RADIUS
                    }).addTo(map);
                    
                    // Force map resize setelah inisialisasi
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                    
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            } else {
                console.error('Map element not found!');
            }
        }

        // Dapatkan lokasi pengguna
        function getUserLocation() {
            const locationInfo = document.getElementById('location-info');
            const getLocationBtn = document.getElementById('get-location');
            
            if (!getLocationBtn) return;
            
            getLocationBtn.disabled = true;
            getLocationBtn.textContent = 'üìç Mencari lokasi...';
            locationInfo.innerHTML = '<p>üîç Mencari lokasi Anda...</p>';

            if (!navigator.geolocation) {
                locationInfo.innerHTML = '<p style="color: red;">‚ùå Geolocation tidak didukung browser ini</p>';
                getLocationBtn.disabled = false;
                getLocationBtn.textContent = 'üìç Dapatkan Lokasi Saya';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Update info lokasi
                    locationInfo.innerHTML = `
                        <p><strong>Latitude:</strong> ${userLocation.lat.toFixed(6)}</p>
                        <p><strong>Longitude:</strong> ${userLocation.lng.toFixed(6)}</p>
                        <p><strong>Akurasi:</strong> ¬±${position.coords.accuracy.toFixed(0)}m</p>
                    `;

                    // Tambahkan marker pengguna
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    userMarker = L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);

                    userMarker.bindPopup('üìç Lokasi Anda');

                    // Hitung jarak dan update status
                    checkAttendanceEligibility();

                    // Reset tombol
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'üîÑ Perbarui Lokasi';

                    // Sesuaikan view peta untuk menampilkan kedua marker
                    const group = new L.featureGroup([userMarker, attendanceMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                },
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '‚ùå Akses lokasi ditolak. Silakan izinkan akses lokasi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '‚ùå Informasi lokasi tidak tersedia.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚ùå Timeout mencari lokasi.';
                            break;
                        default:
                            errorMsg = '‚ùå Error tidak dikenal.';
                            break;
                    }
                    
                    locationInfo.innerHTML = `<p style="color: red;">${errorMsg}</p>`;
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'üìç Coba Lagi';
                }
            );
        }

        // Hitung jarak antara dua koordinat (Haversine formula)
        function calculateDistancePeta(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Radius bumi dalam meter
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Jarak dalam meter
        }

        // Periksa kelayakan absensi
        function checkAttendanceEligibility() {
            if (!userLocation) return;

            const distance = calculateDistancePeta(
                userLocation.lat, userLocation.lng,
                ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng
            );

            const statusDiv = document.getElementById('attendance-status');
            const distanceInfo = document.getElementById('distance-info');
            const absenBtn = document.getElementById('absen-peta-btn');

            if (!statusDiv || !distanceInfo || !absenBtn) return;

            distanceInfo.innerHTML = `üìè Jarak dari lokasi absensi: <strong>${distance.toFixed(1)} meter</strong>`;

            // Cek apakah nama, NIM, dan mata kuliah sudah diisi
            const mahasiswaName = document.getElementById('mahasiswaName').value.trim();
            const mahasiswaNIM = document.getElementById('mahasiswaNIM').value.trim();
            const mahasiswaMatkul = document.getElementById('mahasiswaMatkul').value;
            const isDataComplete = mahasiswaName && mahasiswaNIM && mahasiswaMatkul;

            if (distance <= ATTENDANCE_RADIUS && isDataComplete) {
                statusDiv.textContent = '‚úÖ Siap untuk absen';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                absenBtn.disabled = false;
                absenBtn.textContent = '‚úÖ ABSEN SEKARANG';
            } else if (distance <= ATTENDANCE_RADIUS && !isDataComplete) {
                statusDiv.textContent = '‚ö†Ô∏è Lengkapi data mahasiswa';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.style.border = '1px solid #ffeaa7';
                absenBtn.disabled = true;
                absenBtn.textContent = '‚ö†Ô∏è Lengkapi Data';
            } else {
                statusDiv.textContent = '‚ùå Di luar radius absensi';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                absenBtn.disabled = true;
                absenBtn.textContent = `‚ùå Terlalu jauh (${(distance - ATTENDANCE_RADIUS).toFixed(1)}m)`;
            }
        }

        // Proses absensi
        function processAttendancePeta() {
            // Validasi input mahasiswa
            const mahasiswaName = document.getElementById('mahasiswaName').value.trim();
            const mahasiswaNIM = document.getElementById('mahasiswaNIM').value.trim();
            const mahasiswaMatkul = document.getElementById('mahasiswaMatkul').value;
            
            if (!mahasiswaName) {
                alert('‚ùå Masukkan nama mahasiswa!');
                document.getElementById('mahasiswaName').focus();
                return;
            }
            
            if (!mahasiswaNIM) {
                alert('‚ùå Masukkan NIM mahasiswa!');
                document.getElementById('mahasiswaNIM').focus();
                return;
            }
            
            if (!mahasiswaMatkul) {
                alert('‚ùå Pilih mata kuliah!');
                document.getElementById('mahasiswaMatkul').focus();
                return;
            }
            
            if (!userLocation) {
                alert('‚ùå Lokasi belum didapatkan!');
                return;
            }

            const distance = calculateDistancePeta(
                userLocation.lat, userLocation.lng,
                ATTENDANCE_LOCATION.lat, ATTENDANCE_LOCATION.lng
            );

            if (distance > ATTENDANCE_RADIUS) {
                alert('‚ùå Anda berada di luar radius absensi!');
                return;
            }

            // Proses absensi
            const absenBtn = document.getElementById('absen-peta-btn');
            absenBtn.disabled = true;
            absenBtn.textContent = '‚è≥ Memproses...';

            // Data absensi
            const attendanceData = {
                name: mahasiswaName,
                nim: mahasiswaNIM,
                matakuliah: mahasiswaMatkul,
                latitude: userLocation.lat,
                longitude: userLocation.lng,
                distance: distance.toFixed(1),
                timestamp: new Date().toISOString()
            };

            // Simulasi API call
            setTimeout(() => {
                alert(`‚úÖ Absensi berhasil!\n\nNama: ${mahasiswaName}\nNIM: ${mahasiswaNIM}\nMata Kuliah: ${mahasiswaMatkul}\nWaktu: ${new Date().toLocaleString('id-ID')}\nJarak: ${distance.toFixed(1)} meter`);
                absenBtn.textContent = '‚úÖ Sudah Absen';
                absenBtn.style.background = '#6c757d';
                
                // Disable input fields setelah absen berhasil
                document.getElementById('mahasiswaName').disabled = true;
                document.getElementById('mahasiswaNIM').disabled = true;
                document.getElementById('mahasiswaMatkul').disabled = true;
            }, 2000);
        }

        // Inisialisasi peta dosen
        function initDosenMap() {
            const mapElement = document.getElementById('dosenMap');
            console.log('Initializing dosen map, element found:', !!mapElement);
            
            if (mapElement) {
                try {
                    // Hapus peta lama jika ada
                    if (dosenMap) {
                        dosenMap.remove();
                    }
                    
                    // Ambil koordinat dari input atau gunakan default
                    const lat = parseFloat(document.getElementById('dosenLat').value) || ATTENDANCE_LOCATION.lat;
                    const lng = parseFloat(document.getElementById('dosenLng').value) || ATTENDANCE_LOCATION.lng;
                    
                    dosenLocation = { lat, lng };
                    
                    // Buat peta dosen
                    dosenMap = L.map('dosenMap', {
                        center: [lat, lng],
                        zoom: 16,
                        zoomControl: true
                    });

                    // Tambahkan tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(dosenMap);
                    
                    // Marker untuk lokasi dosen
                    dosenMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(dosenMap);

                    dosenMarker.bindPopup(`
                        <b>Lokasi Kelas Dosen</b><br>
                        Radius Absensi: ${ATTENDANCE_RADIUS}m
                    `);

                    // Lingkaran radius absensi
                    dosenRadiusCircle = L.circle([lat, lng], {
                        color: 'green',
                        fillColor: '#0f3',
                        fillOpacity: 0.2,
                        radius: ATTENDANCE_RADIUS
                    }).addTo(dosenMap);
                    
                    // Force map resize
                    setTimeout(() => {
                        dosenMap.invalidateSize();
                    }, 100);
                    
                    console.log('Dosen map initialized successfully');
                    
                } catch (error) {
                    console.error('Error initializing dosen map:', error);
                }
            }
        }
        
        // Center peta dosen ke lokasi yang diset
        function centerDosenMap() {
            const lat = parseFloat(document.getElementById('dosenLat').value);
            const lng = parseFloat(document.getElementById('dosenLng').value);
            
            if (dosenMap && lat && lng) {
                dosenMap.setView([lat, lng], 16);
                
                // Update marker dan circle
                if (dosenMarker) {
                    dosenMarker.setLatLng([lat, lng]);
                }
                if (dosenRadiusCircle) {
                    dosenRadiusCircle.setLatLng([lat, lng]);
                }
            }
        }

        // Update waktu real-time
        function updateTime() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleString('id-ID');
            }
        }

        // Event listeners untuk peta
        document.addEventListener('DOMContentLoaded', function() {
            // Update waktu setiap detik
            updateTime();
            setInterval(updateTime, 1000);

            // Event listeners untuk tombol peta
            const getLocationBtn = document.getElementById('get-location');
            const absenPetaBtn = document.getElementById('absen-peta-btn');
            
            if (getLocationBtn) {
                getLocationBtn.addEventListener('click', getUserLocation);
            }
            
            if (absenPetaBtn) {
                absenPetaBtn.addEventListener('click', processAttendancePeta);
            }
            
            // Event listeners untuk input mahasiswa
            const mahasiswaName = document.getElementById('mahasiswaName');
            const mahasiswaNIM = document.getElementById('mahasiswaNIM');
            const mahasiswaMatkul = document.getElementById('mahasiswaMatkul');
            
            if (mahasiswaName) {
                mahasiswaName.addEventListener('input', checkAttendanceEligibility);
            }
            
            if (mahasiswaNIM) {
                mahasiswaNIM.addEventListener('input', checkAttendanceEligibility);
            }
            
            if (mahasiswaMatkul) {
                mahasiswaMatkul.addEventListener('change', checkAttendanceEligibility);
            }
        });

        // Zoom Meeting Functions
        let currentMeetingId = null;
        
        // Create Zoom Meeting
        async function createZoomMeeting() {
            const title = document.getElementById('meetingTitle').value.trim();
            const matkul = document.getElementById('zoomMeetingMatkul').value;
            const duration = document.getElementById('meetingDuration').value;
            const pmi = document.getElementById('personalMeetingId').value.trim();
            
            if (!title) {
                alert('‚ùå Masukkan judul meeting!');
                return;
            }
            
            if (!matkul) {
                alert('‚ùå Pilih mata kuliah!');
                return;
            }
            
            // Validasi PMI jika diisi (hapus spasi dan validasi)
            if (pmi) {
                const cleanPmi = pmi.replace(/\s+/g, ''); // Hapus semua spasi
                if (cleanPmi.length < 9 || cleanPmi.length > 11 || !/^\d+$/.test(cleanPmi)) {
                    alert('‚ùå Personal Meeting ID harus berupa 9-11 digit angka!\nContoh: 282 899 2827 atau 2828992827');
                    return;
                }
                // Update pmi dengan format yang sudah dibersihkan
                document.getElementById('personalMeetingId').value = cleanPmi;
            }
            
            try {
                const response = await fetch(`${API_BASE}/zoom/create-meeting`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        matakuliah: matkul,
                        duration: parseInt(duration),
                        dosenId: currentUser.id,
                        pmi: pmi || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentMeetingId = result.meetingId;
                    showActiveMeeting(result);
                    showResult('createMeetingResult', 'Meeting berhasil dibuat!', 'success');
                } else {
                    showResult('createMeetingResult', result.message, 'error');
                }
            } catch (error) {
                showResult('createMeetingResult', 'Error: ' + error.message, 'error');
            }
        }
        
        // Show Active Meeting
        function showActiveMeeting(meetingData) {
            document.getElementById('activeMeetingId').textContent = meetingData.meetingId;
            document.getElementById('manualMeetingId').textContent = meetingData.meetingId;
            document.getElementById('activeMeetingUrl').href = meetingData.joinUrl;
            document.getElementById('activeMeetingUrl').textContent = meetingData.joinUrl;
            document.getElementById('activeMeetingPassword').textContent = meetingData.password || 'Tidak ada';
            document.getElementById('activeMeeting').style.display = 'block';
            document.getElementById('zoomStatus').textContent = 'Meeting Aktif';
        }
        
        // Copy Meeting Info
        function copyMeetingInfo() {
            const meetingId = document.getElementById('activeMeetingId').textContent;
            const password = document.getElementById('activeMeetingPassword').textContent;
            const joinUrl = document.getElementById('activeMeetingUrl').href;
            
            const meetingInfo = `üìπ ZOOM MEETING INFO\n\nüéØ Meeting ID: ${meetingId}\nüîó Join URL: ${joinUrl}\nüîë Password: ${password}\n\nüì± Cara Join:\n1. Buka aplikasi Zoom\n2. Klik "Join Meeting"\n3. Masukkan Meeting ID: ${meetingId}\n4. Masukkan Password jika diminta`;
            
            navigator.clipboard.writeText(meetingInfo).then(() => {
                alert('‚úÖ Info meeting berhasil disalin ke clipboard!');
            }).catch(() => {
                // Fallback untuk browser yang tidak support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = meetingInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Info meeting berhasil disalin!');
            });
        }
        
        // End Zoom Meeting
        async function endZoomMeeting() {
            if (!currentMeetingId) {
                alert('‚ùå Tidak ada meeting aktif!');
                return;
            }
            
            const confirm = window.confirm('Akhiri meeting dan proses absensi otomatis?');
            if (!confirm) return;
            
            try {
                const response = await fetch(`${API_BASE}/zoom/end-meeting`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        meetingId: currentMeetingId,
                        dosenId: currentUser.id
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('activeMeeting').style.display = 'none';
                    document.getElementById('zoomStatus').textContent = 'Tidak Aktif';
                    currentMeetingId = null;
                    alert(`‚úÖ Meeting berakhir!\n\nAbsensi otomatis: ${result.attendanceCount} mahasiswa`);
                    loadMeetingHistory();
                } else {
                    alert('‚ùå Error: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Refresh Participants
        async function refreshParticipants() {
            if (!currentMeetingId) return;
            
            try {
                // Simulasi refresh participants
                const count = Math.floor(Math.random() * 30) + 5;
                document.getElementById('participantCount').textContent = count;
            } catch (error) {
                console.error('Error refreshing participants:', error);
            }
        }
        
        // Load Meeting History
        async function loadMeetingHistory() {
            if (!currentUser || currentUser.role !== 'dosen') return;
            
            try {
                const response = await fetch(`${API_BASE}/zoom/meetings/${currentUser.id}`);
                const meetings = await response.json();
                
                const historyList = document.getElementById('meetingHistoryList');
                historyList.innerHTML = '<h5>üìä Riwayat Meeting:</h5>';
                
                if (meetings.length === 0) {
                    historyList.innerHTML += '<p>Belum ada riwayat meeting.</p>';
                    return;
                }
                
                meetings.forEach(meeting => {
                    const date = new Date(meeting.createdAt).toLocaleString('id-ID');
                    historyList.innerHTML += `
                        <div class="meeting-item" style="border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <strong>${meeting.title}</strong><br>
                            <small>Mata Kuliah: ${meeting.matakuliah}</small><br>
                            <small>Tanggal: ${date}</small><br>
                            <small>Peserta: ${meeting.attendanceCount || 0} mahasiswa</small><br>
                            <span class="badge ${meeting.status === 'ended' ? 'badge-success' : 'badge-warning'}">
                                ${meeting.status === 'ended' ? 'Selesai' : 'Aktif'}
                            </span>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading meeting history:', error);
            }
        }
        
        // Setup Zoom Info
        function setupZoomInfo() {
            if (currentUser && currentUser.role === 'dosen') {
                document.getElementById('zoomDosenName').textContent = currentUser.name || 'Tidak tersedia';
                
                // Sync dengan mata kuliah dosen jika sudah dipilih
                const dosenMatkul = document.getElementById('dosenMatkul');
                if (dosenMatkul && dosenMatkul.value) {
                    document.getElementById('zoomMatkul').textContent = dosenMatkul.value;
                    document.getElementById('zoomMeetingMatkul').value = dosenMatkul.value;
                }
            }
        }

        // Override showTab function untuk handle peta
        const originalShowTab = window.showTab;
        window.showTab = function(tabName) {
            console.log('Switching to tab:', tabName);
            
            if (originalShowTab) {
                originalShowTab(tabName);
            }
            
            // Inisialisasi peta ketika tab absenPeta dibuka
            if (tabName === 'absenPeta') {
                console.log('Initializing map for absenPeta tab');
                setTimeout(() => {
                    initMap();
                    // Auto-get location saat tab dibuka
                    setTimeout(() => {
                        if (typeof getUserLocation === 'function') {
                            getUserLocation();
                        }
                    }, 1500);
                }, 300);
            }
            
            // Inisialisasi peta dosen ketika tab dosen dibuka
            if (tabName === 'dosen') {
                console.log('Initializing dosen map for dosen tab');
                setTimeout(() => {
                    initDosenMap();
                }, 300);
            }
            
            // Setup Zoom info ketika tab zoom dibuka
            if (tabName === 'zoom') {
                console.log('Setting up Zoom tab');
                setTimeout(() => {
                    setupZoomInfo();
                    loadMeetingHistory();
                }, 300);
            }
            
            // Setup Zoom mahasiswa ketika tab zoomMahasiswa dibuka
            if (tabName === 'zoomMahasiswa') {
                console.log('Setting up Zoom Mahasiswa tab');
                setTimeout(() => {
                    setupMahasiswaZoomInfo();
                    loadMahasiswaMeetingHistory();
                }, 300);
            }
        };
        
        // Show Zoom Instructions
        function showZoomInstructions() {
            const instructions = `üìπ CARA MENDAPATKAN PMI ZOOM\n\nüî¥ LANGKAH-LANGKAH:\n\n1. üåê Buka browser, kunjungi: zoom.us\n\n2. üîë Klik "Sign In" dan login dengan akun Zoom Anda\n\n3. üë§ Klik "Profile" di menu atas\n\n4. üéØ Cari "Personal Meeting ID (PMI)"\n   - Akan terlihat angka seperti: 282 899 2827\n   - Ini adalah PMI Anda\n\n5. üìã Copy PMI tersebut\n\n6. üîô Kembali ke aplikasi ini\n\n7. üìù Paste PMI di field "Personal Meeting ID"\n\n8. üöÄ Klik "Buat Meeting"\n\n‚úÖ SEKARANG MEETING ID AKAN VALID!\n\n‚ö†Ô∏è PENTING:\n- Tanpa PMI = Meeting tidak akan bekerja\n- PMI harus dari akun Zoom Anda sendiri\n- Setiap orang punya PMI yang berbeda\n\nüìû Masih bingung? Tanya admin sistem.`;
            
            alert(instructions);
        }
        
        // Fill Example PMI for testing
        function fillExamplePMI() {
            document.getElementById('personalMeetingId').value = '282 899 2827';
            document.getElementById('meetingTitle').value = 'Test Meeting - ' + new Date().toLocaleTimeString('id-ID');
            document.getElementById('zoomMeetingMatkul').value = 'Pemrograman Web';
            alert('‚úÖ Contoh PMI dan data meeting telah diisi!\n\nPMI: 282 899 2827\n\n‚ö†Ô∏è Catatan: Ini hanya contoh untuk testing UI.');
        }
        
        // Mahasiswa Zoom Functions
        let currentMeetingTimer = null;
        let meetingStartTime = null;
        
        // Join Zoom Meeting (Mahasiswa)
        function joinZoomMeeting() {
            const meetingId = document.getElementById('joinMeetingId').value.trim();
            const password = document.getElementById('joinMeetingPassword').value.trim();
            const displayName = document.getElementById('joinDisplayName').value.trim();
            
            if (!meetingId) {
                alert('‚ùå Masukkan Meeting ID!');
                return;
            }
            
            if (!displayName) {
                alert('‚ùå Masukkan nama untuk ditampilkan!');
                return;
            }
            
            // Clean meeting ID (remove spaces)
            const cleanMeetingId = meetingId.replace(/\s+/g, '');
            
            // Validate meeting ID format
            if (cleanMeetingId.length < 9 || cleanMeetingId.length > 11 || !/^\d+$/.test(cleanMeetingId)) {
                alert('‚ùå Meeting ID harus berupa 9-11 digit angka!\nContoh: 282 899 2827');
                return;
            }
            
            // Create Zoom URL
            let zoomUrl = `https://zoom.us/j/${cleanMeetingId}`;
            if (password) {
                zoomUrl += `?pwd=${password}`;
            }
            
            // Add display name parameter
            const separator = password ? '&' : '?';
            zoomUrl += `${separator}uname=${encodeURIComponent(displayName)}`;
            
            // Show active meeting info
            showActiveMeetingInfo(cleanMeetingId, displayName);
            
            // Open Zoom
            window.open(zoomUrl, '_blank');
            
            // Record attendance
            recordMeetingAttendance(cleanMeetingId, displayName);
            
            showResult('joinMeetingResult', `‚úÖ Membuka Zoom Meeting...\n\nMeeting ID: ${meetingId}\nNama: ${displayName}`, 'success');
        }
        
        // Show Active Meeting Info
        function showActiveMeetingInfo(meetingId, displayName) {
            document.getElementById('currentMeetingId').textContent = meetingId;
            document.getElementById('currentDisplayName').textContent = displayName;
            document.getElementById('activeMeetingInfo').style.display = 'block';
            document.getElementById('zoomMahasiswaStatus').textContent = 'Sedang dalam meeting';
            
            // Start timer
            meetingStartTime = new Date();
            startMeetingTimer();
        }
        
        // Start Meeting Timer
        function startMeetingTimer() {
            if (currentMeetingTimer) {
                clearInterval(currentMeetingTimer);
            }
            
            currentMeetingTimer = setInterval(() => {
                if (meetingStartTime) {
                    const now = new Date();
                    const duration = Math.floor((now - meetingStartTime) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    
                    document.getElementById('meetingDuration').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        // Leave Meeting
        function leaveMeeting() {
            const confirm = window.confirm('Keluar dari meeting?');
            if (!confirm) return;
            
            document.getElementById('activeMeetingInfo').style.display = 'none';
            document.getElementById('zoomMahasiswaStatus').textContent = 'Keluar dari meeting';
            
            if (currentMeetingTimer) {
                clearInterval(currentMeetingTimer);
                currentMeetingTimer = null;
            }
            
            // Record leave time
            recordMeetingLeave();
            
            alert('‚úÖ Anda telah keluar dari meeting.');
        }
        
        // Toggle Mute (Placeholder)
        function toggleMute() {
            alert('üé§ Fitur mute/unmute hanya tersedia di aplikasi Zoom.');
        }
        
        // Scan QR Code (Placeholder)
        function scanQRCode() {
            alert('üì± Fitur scan QR code akan tersedia di versi mobile app.');
        }
        
        // Record Meeting Attendance
        async function recordMeetingAttendance(meetingId, displayName) {
            try {
                const attendanceData = {
                    meetingId: meetingId,
                    studentName: displayName,
                    studentId: currentUser ? currentUser.id : null,
                    joinTime: new Date().toISOString(),
                    status: 'joined'
                };
                
                // Simulate API call to record attendance
                console.log('Recording attendance:', attendanceData);
                
                // In production, send to server:
                // await fetch(`${API_BASE}/zoom/record-attendance`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(attendanceData)
                // });
                
            } catch (error) {
                console.error('Error recording attendance:', error);
            }
        }
        
        // Record Meeting Leave
        async function recordMeetingLeave() {
            try {
                const leaveData = {
                    leaveTime: new Date().toISOString(),
                    duration: meetingStartTime ? Math.floor((new Date() - meetingStartTime) / 1000) : 0
                };
                
                console.log('Recording leave:', leaveData);
                
            } catch (error) {
                console.error('Error recording leave:', error);
            }
        }
        
        // Load Mahasiswa Meeting History
        function loadMahasiswaMeetingHistory() {
            const historyList = document.getElementById('mahasiswaMeetingHistoryList');
            
            // Simulate meeting history
            const sampleHistory = [
                {
                    meetingId: '282 899 2827',
                    title: 'Kuliah Pemrograman Web',
                    date: new Date(Date.now() - 86400000).toLocaleDateString('id-ID'),
                    duration: '45 menit',
                    status: 'Hadir'
                },
                {
                    meetingId: '123 456 7890',
                    title: 'Kuliah Basis Data',
                    date: new Date(Date.now() - 172800000).toLocaleDateString('id-ID'),
                    duration: '60 menit',
                    status: 'Hadir'
                }
            ];
            
            historyList.innerHTML = '<h5>üìä Riwayat Meeting:</h5>';
            
            sampleHistory.forEach(meeting => {
                const statusClass = meeting.status === 'Hadir' ? 'badge-success' : 'badge-warning';
                historyList.innerHTML += `
                    <div class="meeting-item" style="border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 8px;">
                        <strong>${meeting.title}</strong><br>
                        <small>Meeting ID: ${meeting.meetingId}</small><br>
                        <small>Tanggal: ${meeting.date}</small><br>
                        <small>Durasi: ${meeting.duration}</small><br>
                        <span class="badge ${statusClass}">${meeting.status}</span>
                    </div>
                `;
            });
        }
        
        // Setup Mahasiswa Zoom Info
        function setupMahasiswaZoomInfo() {
            if (currentUser && currentUser.role === 'mahasiswa') {
                document.getElementById('zoomMahasiswaName').textContent = currentUser.name || 'Tidak tersedia';
                document.getElementById('zoomMahasiswaNIM').textContent = currentUser.email || 'Tidak tersedia';
                
                // Auto-fill display name
                document.getElementById('joinDisplayName').value = currentUser.name || '';
            }
        }
        
        // Tambahkan event listener untuk tab absenPeta
        document.addEventListener('DOMContentLoaded', function() {
            const absenPetaTab = document.getElementById('absenPetaTab');
            if (absenPetaTab) {
                absenPetaTab.addEventListener('click', function() {
                    console.log('AbsenPeta tab clicked directly');
                    setTimeout(() => {
                        initMap();
                    }, 300);
                });
            }
        });
    </script>
  </body>
</html>
